<%
  depth_percentage = max_depth > 0 ? (category.drip_depth / max_depth * 100) : 0
  min_height = 60
  max_height = 400
  drip_height = min_height + (depth_percentage / 100.0 * (max_height - min_height))
  saturation = 70 + (depth_percentage / 100.0 * 30)
%>

<div class="drip-column flex flex-col items-center cursor-pointer transition-all duration-300 hover:scale-105"
     data-drip-id="<%= category.id %>"
     data-action="click->paint-drip#toggle">

  <!-- The Drip Shape -->
  <div class="drip relative"
       style="width: 48px; height: <%= drip_height.to_i %>px;">
    <svg viewBox="0 0 48 100" preserveAspectRatio="none" class="w-full h-full" style="filter: saturate(<%= saturation.to_i %>%);">
      <defs>
        <linearGradient id="drip-gradient-<%= category.id %>" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color: var(--color-primary); stop-opacity: 0.9;" />
          <stop offset="100%" style="stop-color: var(--color-primary); stop-opacity: 0.6;" />
        </linearGradient>
      </defs>
      <path d="M 0,0 L 48,0 L 46,85 Q 44,95 38,98 Q 24,105 10,98 Q 4,95 2,85 Z"
            fill="url(#drip-gradient-<%= category.id %>)" />
    </svg>

    <!-- Engagement Icons -->
    <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-0.5">
      <% category.engagement_types_present.each do |type| %>
        <span class="text-xs opacity-80" title="<%= type.humanize %>">
          <%= case type
              when 'consumed' then 'ðŸ“–'
              when 'experimented' then 'ðŸ§ª'
              when 'applied' then 'ðŸ”¨'
              when 'shared' then 'ðŸ“£'
              end %>
        </span>
      <% end %>
    </div>
  </div>

  <!-- Expanded Moments (hidden by default) -->
  <div data-paint-drip-target="moments" class="hidden mt-4 w-64 bg-surface border border-muted/20 rounded-lg p-4 shadow-lg">
    <h3 class="font-semibold text-text mb-3"><%= category.name %></h3>
    <div class="space-y-2 max-h-80 overflow-y-auto">
      <% category.learning_moments.chronological.each do |moment| %>
        <%= render "learning/droplet", moment: moment %>
      <% end %>
    </div>
  </div>
</div>
