<div class="paint-drip-canvas py-16">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 overflow-x-auto">
    <%
      # Fixed width per category for consistent drip appearance
      category_width = 100
      canvas_width = categories.count * category_width + 100

      # Dynamic drip range and canvas height based on data
      min_drip_length = 40
      max_drip_length = 550
      canvas_height = 65 + max_drip_length + 60
    %>
    <svg style="width: <%= canvas_width %>px;" viewBox="0 0 <%= canvas_width %> <%= canvas_height %>" preserveAspectRatio="xMidYMin meet">
      <defs>
        <!-- Color palette for paint drips - matte colors varying left to right -->
        <%
          drip_colors = ['#E85D75', '#F97316', '#FBBF24', '#22C55E', '#14B8A6', '#3B82F6', '#8B5CF6', '#EC4899', '#6366F1']
        %>
        <% drip_colors.each_with_index do |color, i| %>
          <linearGradient id="drip-color-<%= i %>" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color: <%= color %>;" />
            <stop offset="100%" style="stop-color: <%= color %>; stop-opacity: 0.85;" />
          </linearGradient>
        <% end %>
      </defs>

      <!-- Paint drips per category - color sections touch each other -->
      <% categories.each_with_index do |category, cat_idx| %>
        <%
          base_x = ((cat_idx + 1) * (canvas_width.to_f / (categories.count + 1))).to_i
          color_idx = cat_idx % drip_colors.length
          color = drip_colors[color_idx]
          depth_percentage = max_depth > 0 ? (category.drip_depth / max_depth * 100) : 0
          base_drip_length = min_drip_length + (depth_percentage / 100.0 * (max_drip_length - min_drip_length))

          # Color section spans from midpoint to previous category to midpoint to next
          spacing = canvas_width.to_f / (categories.count + 1)
          section_start = cat_idx == 0 ? 0 : (base_x - spacing / 2).to_i
          section_end = cat_idx == categories.count - 1 ? canvas_width : (base_x + spacing / 2).to_i
          section_width = section_end - section_start
        %>

        <!-- Color section on top band - touching adjacent sections -->
        <rect x="<%= section_start %>" y="20"
              width="<%= section_width %>" height="50"
              fill="<%= color %>"/>

        <!-- Drips - all within the color section bounds -->
        <%
          # Drip positions relative to base_x, staying within color_section_width
          drips = [
            { offset: -22, length_mult: 0.65, width: 12 },  # left
            { offset: -8,  length_mult: 0.85, width: 16 },  # left-center
            { offset: 5,   length_mult: 1.0,  width: 22 },  # main (slightly right of center)
            { offset: 20,  length_mult: 0.75, width: 14 },  # right
          ]
        %>

        <g class="drip-group cursor-pointer"
           data-drip-id="<%= category.id %>"
           data-action="click->paint-drip#toggle">
          <% drips.each do |drip| %>
            <%
              x = base_x + drip[:offset]
              drip_length = base_drip_length * drip[:length_mult]
              width = drip[:width]
              y_start = 65
              y_end = y_start + drip_length
              bulb_r = width * 0.55
            %>
            <path d="M <%= x - width/2 %>,<%= y_start %>
                     Q <%= x - width/2 %>,<%= y_end - bulb_r * 2 %>
                       <%= x - bulb_r %>,<%= y_end - bulb_r %>
                     Q <%= x - bulb_r %>,<%= y_end %>
                       <%= x %>,<%= y_end + bulb_r * 0.3 %>
                     Q <%= x + bulb_r %>,<%= y_end %>
                       <%= x + bulb_r %>,<%= y_end - bulb_r %>
                     Q <%= x + width/2 %>,<%= y_end - bulb_r * 2 %>
                       <%= x + width/2 %>,<%= y_start %>
                     Z"
                  fill="<%= color %>"/>
          <% end %>
        </g>
      <% end %>

      <!-- Category names - on top band, wrapped for long names -->
      <% categories.each_with_index do |category, index| %>
        <%
          x_pos = ((index + 1) * (canvas_width.to_f / (categories.count + 1))).to_i
          words = category.name.split(/[\s\/]+/)
          # Split into lines that fit ~14 chars each
          lines = []
          current_line = ""
          words.each do |word|
            separator = category.name.include?("/") && current_line.present? ? "/" : " "
            if current_line.empty?
              current_line = word
            elsif (current_line + separator + word).length <= 14
              current_line += separator + word
            else
              lines << current_line
              current_line = word
            end
          end
          lines << current_line if current_line.present?
          line_height = 13
          total_text_height = lines.count * line_height
          start_y = 50 - (total_text_height - line_height) / 2.0
        %>
        <text x="<%= x_pos %>" y="<%= start_y %>"
              text-anchor="middle"
              style="font-size: 11px; font-weight: 600; fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
          <% lines.each_with_index do |line, li| %>
            <tspan x="<%= x_pos %>" dy="<%= li == 0 ? 0 : line_height %>"><%= line %></tspan>
          <% end %>
        </text>
      <% end %>

      <!-- Learning moment icons along main drips -->
      <% categories.each_with_index do |category, index| %>
        <%
          x_pos = ((index + 1) * (canvas_width.to_f / (categories.count + 1))).to_i
          depth_percentage = max_depth > 0 ? (category.drip_depth / max_depth * 100) : 0
          drip_length = min_drip_length + (depth_percentage / 100.0 * (max_drip_length - min_drip_length))
          y_start = 65
          moments = category.learning_moments.chronological.to_a
          moment_count = moments.count
          color_idx = index % drip_colors.length
        %>

        <% if moment_count > 0 %>
          <% usable_length = drip_length - 40 %>
          <% moments.each_with_index do |moment, m_idx| %>
            <%
              progress = moment_count > 1 ? m_idx.to_f / (moment_count - 1) : 0.5
              icon_y = y_start + 20 + (progress * usable_length)
            %>
            <text x="<%= x_pos %>" y="<%= icon_y %>"
                  text-anchor="middle"
                  dominant-baseline="central"
                  style="font-size: 14px; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));">
              <%= case moment.engagement_type
                  when 'consumed' then 'ðŸ“–'
                  when 'experimented' then 'ðŸ§ª'
                  when 'applied' then 'ðŸ”¨'
                  when 'shared' then 'ðŸ“£'
                  end %>
            </text>
          <% end %>
        <% end %>
      <% end %>
    </svg>

  </div>
</div>
