<div class="paint-drip-canvas py-16" data-controller="paint-drip" data-action="click@window->paint-drip#closeOnClickOutside">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Combined Brush Stroke with Drips -->
    <svg class="w-full" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMin meet">
      <defs>
        <!-- Gradient for the paint -->
        <linearGradient id="paint-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color: var(--theme-primary); stop-opacity: 1;" />
          <stop offset="50%" style="stop-color: var(--theme-primary); stop-opacity: 0.9;" />
          <stop offset="100%" style="stop-color: var(--theme-primary); stop-opacity: 0.75;" />
        </linearGradient>

        <!-- Highlight gradient for shine effect -->
        <linearGradient id="paint-highlight" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color: white; stop-opacity: 0;" />
          <stop offset="30%" style="stop-color: white; stop-opacity: 0.15;" />
          <stop offset="50%" style="stop-color: white; stop-opacity: 0;" />
        </linearGradient>

        <!-- Subtle texture filter -->
        <filter id="paint-texture" x="-2%" y="-2%" width="104%" height="104%">
          <feTurbulence type="fractalNoise" baseFrequency="0.03" numOctaves="2" result="noise"/>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G"/>
        </filter>
      </defs>

      <!-- Main brush stroke band -->
      <path d="M 0,30
               Q 100,15 200,28
               Q 350,45 500,25
               Q 650,40 800,30
               Q 900,20 1000,35
               L 1000,55
               Q 900,50 800,58
               Q 650,52 500,60
               Q 350,55 200,62
               Q 100,58 0,55
               Z"
            fill="url(#paint-gradient)"
            filter="url(#paint-texture)"/>

      <!-- Brush stroke highlight -->
      <path d="M 0,35
               Q 100,25 200,35
               Q 350,45 500,32
               Q 650,42 800,38
               Q 900,30 1000,40
               L 1000,45
               Q 900,38 800,45
               Q 650,40 500,48
               Q 350,42 200,50
               Q 100,45 0,48
               Z"
            fill="url(#paint-highlight)"/>

      <!-- Drips flowing from the brush stroke -->
      <% categories.each_with_index do |category, index| %>
        <%
          # Calculate x position for this drip
          x_pos = ((index + 1) * (1000.0 / (categories.count + 1))).to_i

          # Calculate drip height based on depth
          depth_percentage = max_depth > 0 ? (category.drip_depth / max_depth * 100) : 0
          min_drip = 100
          max_drip = 350
          drip_length = min_drip + (depth_percentage / 100.0 * (max_drip - min_drip))

          # Consistent width for cleaner look
          drip_w = 24
          half_w = drip_w / 2

          # Drip coordinates
          y_start = 52
          y_end = y_start + drip_length

          # Engagement types with their vertical positions (distributed along drip)
          engagement_positions = {
            'consumed' => 0.15,      # Near top
            'experimented' => 0.35,  # Upper-middle
            'applied' => 0.55,       # Lower-middle
            'shared' => 0.75         # Near bottom
          }
        %>

        <!-- Drip shape -->
        <g class="drip-group cursor-pointer transition-all duration-300 hover:brightness-110"
           data-drip-id="<%= category.id %>"
           data-action="click->paint-drip#toggle">

          <!-- Classic teardrop drip shape -->
          <path d="M <%= x_pos %>,<%= y_start %>
                   C <%= x_pos - half_w %>,<%= y_start + 20 %> <%= x_pos - half_w - 2 %>,<%= y_end - 40 %> <%= x_pos %>,<%= y_end %>
                   C <%= x_pos + half_w + 2 %>,<%= y_end - 40 %> <%= x_pos + half_w %>,<%= y_start + 20 %> <%= x_pos %>,<%= y_start %>
                   Z"
                fill="url(#paint-gradient)"
                filter="url(#paint-texture)"/>

          <!-- Drip highlight for depth -->
          <path d="M <%= x_pos - 2 %>,<%= y_start + 15 %>
                   C <%= x_pos - half_w + 5 %>,<%= y_start + 30 %> <%= x_pos - half_w + 6 %>,<%= y_end - 60 %> <%= x_pos - 3 %>,<%= y_end - 20 %>
                   C <%= x_pos - half_w + 8 %>,<%= y_end - 50 %> <%= x_pos - half_w + 7 %>,<%= y_start + 25 %> <%= x_pos - 2 %>,<%= y_start + 15 %>
                   Z"
                fill="url(#paint-highlight)"
                style="opacity: 0.4;"/>

          <!-- Category name in the brush stroke -->
          <text x="<%= x_pos %>" y="42"
                text-anchor="middle"
                class="fill-current"
                style="font-size: 13px; font-weight: 600; fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
            <%= category.name %>
          </text>

          <!-- Engagement icons distributed along the drip -->
          <% category.engagement_types_present.each do |type| %>
            <%
              icon_y = y_start + (drip_length * engagement_positions[type])
            %>
            <text x="<%= x_pos %>" y="<%= icon_y %>"
                  text-anchor="middle"
                  dominant-baseline="middle"
                  style="font-size: 16px; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));">
              <%= case type
                  when 'consumed' then 'ðŸ“–'
                  when 'experimented' then 'ðŸ§ª'
                  when 'applied' then 'ðŸ”¨'
                  when 'shared' then 'ðŸ“£'
                  end %>
            </text>
          <% end %>
        </g>
      <% end %>
    </svg>

    <!-- Expanded moments panels (positioned below) -->
    <div class="drips-details flex justify-around px-8 mt-4">
      <% categories.each do |category| %>
        <div data-drip-id="<%= category.id %>" class="drip-detail-container flex-1 max-w-xs mx-2">
          <div data-paint-drip-target="moments" class="hidden bg-surface border border-muted/20 rounded-lg p-4 shadow-lg">
            <h3 class="font-semibold text-text mb-3"><%= category.name %></h3>
            <div class="space-y-2 max-h-80 overflow-y-auto">
              <% category.learning_moments.chronological.each do |moment| %>
                <%= render "learning/droplet", moment: moment %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
