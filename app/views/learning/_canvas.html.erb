<div class="paint-drip-canvas py-16" data-controller="paint-drip" data-action="click@window->paint-drip#closeOnClickOutside">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 overflow-x-auto">
    <%
      # Fixed width per category for consistent drip appearance
      category_width = 100
      min_canvas_width = 1000
      canvas_width = [categories.count * category_width + 100, min_canvas_width].max
    %>
    <svg class="min-w-full" style="width: <%= canvas_width %>px;" viewBox="0 0 <%= canvas_width %> 480" preserveAspectRatio="xMidYMin meet">
      <defs>
        <!-- Color palette for paint drips - matte colors varying left to right -->
        <%
          drip_colors = ['#E85D75', '#F97316', '#FBBF24', '#22C55E', '#14B8A6', '#3B82F6', '#8B5CF6', '#EC4899', '#6366F1']
        %>
        <% drip_colors.each_with_index do |color, i| %>
          <linearGradient id="drip-color-<%= i %>" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color: <%= color %>;" />
            <stop offset="100%" style="stop-color: <%= color %>; stop-opacity: 0.85;" />
          </linearGradient>
        <% end %>
      </defs>

      <!-- Paint drips - overlapping, matte, varying colors -->
      <%
        # Generate multiple drips per category for overlap effect
        all_drips = []
        categories.each_with_index do |category, cat_idx|
          base_x = ((cat_idx + 1) * (canvas_width.to_f / (categories.count + 1))).to_i
          depth_percentage = max_depth > 0 ? (category.drip_depth / max_depth * 100) : 0
          base_drip_length = 100 + (depth_percentage / 100.0 * 280)

          # Main drip
          all_drips << { x: base_x, length: base_drip_length, width: 28, cat_idx: cat_idx, category: category, is_main: true }

          # Secondary drips for overlap effect
          all_drips << { x: base_x - 22, length: base_drip_length * 0.7, width: 18, cat_idx: cat_idx, category: category, is_main: false }
          all_drips << { x: base_x + 20, length: base_drip_length * 0.85, width: 20, cat_idx: cat_idx, category: category, is_main: false }
        end
      %>

      <!-- Top paint band -->
      <rect x="0" y="20" width="<%= canvas_width %>" height="50" fill="#2D2D2D"/>

      <!-- Color sections on top band -->
      <% categories.each_with_index do |category, index| %>
        <%
          section_width = canvas_width.to_f / categories.count
          x_start = index * section_width
          color_idx = index % drip_colors.length
        %>
        <rect x="<%= x_start %>" y="20" width="<%= section_width + 1 %>" height="50"
              fill="<%= drip_colors[color_idx] %>"/>
      <% end %>

      <!-- All drips sorted by x for natural overlap -->
      <% all_drips.sort_by { |d| d[:x] }.each do |drip| %>
        <%
          x = drip[:x]
          drip_length = drip[:length]
          width = drip[:width]
          color_idx = drip[:cat_idx] % drip_colors.length
          color = drip_colors[color_idx]

          y_start = 65
          y_end = y_start + drip_length
          bulb_r = width * 0.6
        %>

        <g class="<%= drip[:is_main] ? 'drip-group cursor-pointer' : '' %>"
           <%= drip[:is_main] ? "data-drip-id=\"#{drip[:category].id}\" data-action=\"click->paint-drip#toggle\"" : '' %>>
          <!-- Tapered drip with rounded end -->
          <path d="M <%= x - width/2 %>,<%= y_start %>
                   Q <%= x - width/2 %>,<%= y_end - bulb_r * 2 %>
                     <%= x - bulb_r %>,<%= y_end - bulb_r %>
                   Q <%= x - bulb_r %>,<%= y_end %>
                     <%= x %>,<%= y_end + bulb_r * 0.3 %>
                   Q <%= x + bulb_r %>,<%= y_end %>
                     <%= x + bulb_r %>,<%= y_end - bulb_r %>
                   Q <%= x + width/2 %>,<%= y_end - bulb_r * 2 %>
                     <%= x + width/2 %>,<%= y_start %>
                   Z"
                fill="<%= color %>"/>
        </g>
      <% end %>

      <!-- Category names - on top band -->
      <% categories.each_with_index do |category, index| %>
        <%
          x_pos = ((index + 1) * (canvas_width.to_f / (categories.count + 1))).to_i
        %>
        <text x="<%= x_pos %>" y="50"
              text-anchor="middle"
              style="font-size: 14px; font-weight: 600; fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
          <%= category.name %>
        </text>
      <% end %>

      <!-- Learning moment icons along main drips -->
      <% categories.each_with_index do |category, index| %>
        <%
          x_pos = ((index + 1) * (canvas_width.to_f / (categories.count + 1))).to_i
          depth_percentage = max_depth > 0 ? (category.drip_depth / max_depth * 100) : 0
          drip_length = 100 + (depth_percentage / 100.0 * 280)
          y_start = 65
          moments = category.learning_moments.chronological.to_a
          moment_count = moments.count
          color_idx = index % drip_colors.length
        %>

        <% if moment_count > 0 %>
          <% usable_length = drip_length - 40 %>
          <% moments.each_with_index do |moment, m_idx| %>
            <%
              progress = moment_count > 1 ? m_idx.to_f / (moment_count - 1) : 0.5
              icon_y = y_start + 20 + (progress * usable_length)
            %>
            <text x="<%= x_pos %>" y="<%= icon_y %>"
                  text-anchor="middle"
                  dominant-baseline="central"
                  style="font-size: 14px; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));">
              <%= case moment.engagement_type
                  when 'consumed' then 'ðŸ“–'
                  when 'experimented' then 'ðŸ§ª'
                  when 'applied' then 'ðŸ”¨'
                  when 'shared' then 'ðŸ“£'
                  end %>
            </text>
          <% end %>
        <% end %>
      <% end %>
    </svg>

    <!-- Expanded moments panels -->
    <div class="drips-details flex justify-around px-8 mt-4">
      <% categories.each do |category| %>
        <div data-drip-id="<%= category.id %>" class="drip-detail-container flex-1 max-w-xs mx-2">
          <div data-paint-drip-target="moments" class="hidden bg-surface border border-muted/20 rounded-lg p-4 shadow-lg">
            <h3 class="font-semibold text-text mb-3"><%= category.name %></h3>
            <div class="space-y-2 max-h-80 overflow-y-auto">
              <% category.learning_moments.chronological.each do |moment| %>
                <%= render "learning/droplet", moment: moment %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
