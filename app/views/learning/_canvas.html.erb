<div class="paint-drip-canvas py-16" data-controller="paint-drip" data-action="click@window->paint-drip#closeOnClickOutside">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Combined Brush Stroke with Drips -->
    <svg class="w-full" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMin meet">
      <defs>
        <!-- Gradient for wet paint look -->
        <linearGradient id="paint-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color: var(--theme-primary); stop-opacity: 1;" />
          <stop offset="70%" style="stop-color: var(--theme-primary); stop-opacity: 0.95;" />
          <stop offset="100%" style="stop-color: var(--theme-primary); stop-opacity: 0.85;" />
        </linearGradient>

        <!-- Glossy highlight for wet paint effect -->
        <linearGradient id="gloss-highlight" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color: white; stop-opacity: 0.35;" />
          <stop offset="50%" style="stop-color: white; stop-opacity: 0;" />
        </linearGradient>

        <!-- Bubble gradient for icons -->
        <radialGradient id="bubble-gradient" cx="30%" cy="30%">
          <stop offset="0%" style="stop-color: white; stop-opacity: 0.6;" />
          <stop offset="100%" style="stop-color: white; stop-opacity: 0.15;" />
        </radialGradient>
      </defs>

      <!-- Wet brush stroke band -->
      <path d="M 0,20
               Q 80,35 160,22
               Q 280,40 400,18
               Q 520,38 640,25
               Q 760,42 880,20
               Q 940,32 1000,25
               L 1000,58
               Q 940,52 880,60
               Q 760,55 640,62
               Q 520,58 400,65
               Q 280,60 160,63
               Q 80,57 0,60
               Z"
            fill="url(#paint-gradient)"/>

      <!-- Brush stroke gloss -->
      <path d="M 0,25
               Q 80,38 160,28
               Q 280,42 400,24
               Q 520,40 640,30
               Q 760,44 880,26
               Q 940,35 1000,30
               L 1000,40
               Q 940,35 880,38
               Q 760,36 640,40
               Q 520,38 400,42
               Q 280,40 160,43
               Q 80,38 0,42
               Z"
            fill="url(#gloss-highlight)"/>

      <!-- Drips flowing from the brush stroke -->
      <% categories.each_with_index do |category, index| %>
        <%
          # Calculate x position for this drip
          x_pos = ((index + 1) * (1000.0 / (categories.count + 1))).to_i

          # Calculate drip height based on depth
          depth_percentage = max_depth > 0 ? (category.drip_depth / max_depth * 100) : 0
          min_drip = 120
          max_drip = 380
          drip_length = min_drip + (depth_percentage / 100.0 * (max_drip - min_drip))

          # Drip dimensions - thick glossy style
          neck_w = 18      # Narrow at top
          mid_w = 28       # Bulges in middle
          blob_w = 34      # Rounded blob at bottom

          # Vertical positions
          y_start = 55
          y_neck = y_start + 25
          y_mid = y_start + drip_length * 0.5
          y_bulge = y_start + drip_length * 0.75
          y_blob_top = y_start + drip_length - 30
          y_end = y_start + drip_length

          # Get learning moments chronologically for bubble positions
          moments = category.learning_moments.chronological.to_a
          moment_count = moments.count
        %>

        <!-- Drip shape - thick glossy with rounded blob bottom -->
        <g class="drip-group cursor-pointer transition-all duration-300 hover:brightness-110"
           data-drip-id="<%= category.id %>"
           data-action="click->paint-drip#toggle">

          <!-- Main drip body -->
          <path d="M <%= x_pos - neck_w/2 %>,<%= y_start %>
                   L <%= x_pos - neck_w/2 %>,<%= y_neck %>
                   Q <%= x_pos - mid_w/2 - 3 %>,<%= y_mid - 20 %> <%= x_pos - mid_w/2 %>,<%= y_mid %>
                   Q <%= x_pos - mid_w/2 + 2 %>,<%= y_bulge - 10 %> <%= x_pos - blob_w/2 %>,<%= y_bulge %>
                   Q <%= x_pos - blob_w/2 - 4 %>,<%= y_blob_top %> <%= x_pos - blob_w/2 + 2 %>,<%= y_blob_top + 10 %>
                   Q <%= x_pos - blob_w/3 %>,<%= y_end + 8 %> <%= x_pos %>,<%= y_end + 12 %>
                   Q <%= x_pos + blob_w/3 %>,<%= y_end + 8 %> <%= x_pos + blob_w/2 - 2 %>,<%= y_blob_top + 10 %>
                   Q <%= x_pos + blob_w/2 + 4 %>,<%= y_blob_top %> <%= x_pos + blob_w/2 %>,<%= y_bulge %>
                   Q <%= x_pos + mid_w/2 - 2 %>,<%= y_bulge - 10 %> <%= x_pos + mid_w/2 %>,<%= y_mid %>
                   Q <%= x_pos + mid_w/2 + 3 %>,<%= y_mid - 20 %> <%= x_pos + neck_w/2 %>,<%= y_neck %>
                   L <%= x_pos + neck_w/2 %>,<%= y_start %>
                   Z"
                fill="url(#paint-gradient)"/>

          <!-- Glossy highlight on drip -->
          <path d="M <%= x_pos - neck_w/2 + 3 %>,<%= y_start + 5 %>
                   L <%= x_pos - neck_w/2 + 3 %>,<%= y_neck %>
                   Q <%= x_pos - mid_w/2 + 5 %>,<%= y_mid - 15 %> <%= x_pos - mid_w/2 + 6 %>,<%= y_mid %>
                   Q <%= x_pos - mid_w/2 + 8 %>,<%= y_bulge - 15 %> <%= x_pos - blob_w/2 + 10 %>,<%= y_bulge %>
                   Q <%= x_pos - blob_w/2 + 8 %>,<%= y_blob_top - 5 %> <%= x_pos - 5 %>,<%= y_blob_top + 15 %>
                   L <%= x_pos - 3 %>,<%= y_mid %>
                   Q <%= x_pos - 4 %>,<%= y_neck + 10 %> <%= x_pos - neck_w/2 + 3 %>,<%= y_start + 5 %>
                   Z"
                fill="url(#gloss-highlight)"
                style="opacity: 0.7;"/>

          <!-- Category name in the brush stroke -->
          <text x="<%= x_pos %>" y="40"
                text-anchor="middle"
                style="font-size: 13px; font-weight: 600; fill: white; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">
            <%= category.name %>
          </text>

          <!-- Learning moment bubbles - chronologically positioned -->
          <% if moment_count > 0 %>
            <% usable_length = drip_length - 60 %>
            <% moments.each_with_index do |moment, m_idx| %>
              <%
                # Position bubbles chronologically along the drip
                # First moment near top, last near bottom
                progress = moment_count > 1 ? m_idx.to_f / (moment_count - 1) : 0.5
                bubble_y = y_start + 40 + (progress * usable_length)
                bubble_r = 11
              %>
              <!-- Bubble -->
              <circle cx="<%= x_pos %>" cy="<%= bubble_y %>" r="<%= bubble_r %>"
                      fill="url(#bubble-gradient)"
                      stroke="rgba(255,255,255,0.3)"
                      stroke-width="1"/>
              <!-- Icon inside bubble -->
              <text x="<%= x_pos %>" y="<%= bubble_y %>"
                    text-anchor="middle"
                    dominant-baseline="central"
                    style="font-size: 12px;">
                <%= case moment.engagement_type
                    when 'consumed' then 'ðŸ“–'
                    when 'experimented' then 'ðŸ§ª'
                    when 'applied' then 'ðŸ”¨'
                    when 'shared' then 'ðŸ“£'
                    end %>
              </text>
            <% end %>
          <% end %>
        </g>
      <% end %>
    </svg>

    <!-- Expanded moments panels (positioned below) -->
    <div class="drips-details flex justify-around px-8 mt-4">
      <% categories.each do |category| %>
        <div data-drip-id="<%= category.id %>" class="drip-detail-container flex-1 max-w-xs mx-2">
          <div data-paint-drip-target="moments" class="hidden bg-surface border border-muted/20 rounded-lg p-4 shadow-lg">
            <h3 class="font-semibold text-text mb-3"><%= category.name %></h3>
            <div class="space-y-2 max-h-80 overflow-y-auto">
              <% category.learning_moments.chronological.each do |moment| %>
                <%= render "learning/droplet", moment: moment %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
