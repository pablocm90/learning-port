<div class="paint-drip-canvas py-16" data-controller="paint-drip" data-action="click@window->paint-drip#closeOnClickOutside">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Combined Brush Stroke with Drips -->
    <svg class="w-full" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMin meet">
      <defs>
        <!-- Main paint gradient -->
        <linearGradient id="paint-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color: var(--theme-primary); stop-opacity: 1;" />
          <stop offset="100%" style="stop-color: var(--theme-primary); stop-opacity: 0.9;" />
        </linearGradient>

        <!-- Bubble gradient - lighter version of paint color -->
        <radialGradient id="bubble-fill" cx="40%" cy="40%">
          <stop offset="0%" style="stop-color: var(--theme-primary); stop-opacity: 0.4;" />
          <stop offset="70%" style="stop-color: var(--theme-primary); stop-opacity: 0.6;" />
          <stop offset="100%" style="stop-color: var(--theme-primary); stop-opacity: 0.75;" />
        </radialGradient>

        <!-- Organic edge filter - adds slight wobble to edges -->
        <filter id="organic-edge" x="-3%" y="-3%" width="106%" height="106%">
          <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" result="noise" seed="1"/>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="4" xChannelSelector="R" yChannelSelector="G"/>
        </filter>

        <!-- Clip paths will be defined per-drip -->
      </defs>

      <!-- Main paint group with organic filter -->
      <g filter="url(#organic-edge)">
        <!-- Brush stroke base - thicker band -->
        <path d="M -10,15
                 Q 80,30 180,18
                 Q 320,42 480,20
                 Q 620,45 780,22
                 Q 900,38 1010,25
                 L 1010,70
                 Q 900,62 780,72
                 Q 620,65 480,75
                 Q 320,68 180,74
                 Q 80,66 -10,72
                 Z"
              fill="url(#paint-gradient)"/>

        <!-- Drips that merge with brush stroke -->
        <% categories.each_with_index do |category, index| %>
          <%
            # Calculate x position for this drip
            x_pos = ((index + 1) * (1000.0 / (categories.count + 1))).to_i

            # Calculate drip height based on depth
            depth_percentage = max_depth > 0 ? (category.drip_depth / max_depth * 100) : 0
            min_drip = 140
            max_drip = 400
            drip_length = min_drip + (depth_percentage / 100.0 * (max_drip - min_drip))

            # Drip dimensions
            merge_w = 50      # Wide where it merges with brush stroke
            neck_w = 20       # Narrows as it flows down
            mid_w = 26        # Slight bulge in middle
            blob_w = 32       # Rounded blob at bottom

            # Vertical positions - starts INSIDE the brush stroke
            y_merge = 45      # Where drip starts merging (inside brush stroke)
            y_exit = 72       # Bottom of brush stroke
            y_neck = y_exit + 30
            y_mid = y_exit + drip_length * 0.45
            y_bulge = y_exit + drip_length * 0.7
            y_blob_top = y_exit + drip_length - 35
            y_end = y_exit + drip_length

            # Get learning moments chronologically for bubble positions
            moments = category.learning_moments.chronological.to_a
            moment_count = moments.count

            # Slight x variation for organic feel
            x_wobble = (index % 3 - 1) * 3
          %>

          <!-- Drip shape - merges smoothly from brush stroke -->
          <g class="drip-group cursor-pointer transition-opacity duration-300 hover:opacity-90"
             data-drip-id="<%= category.id %>"
             data-action="click->paint-drip#toggle">

            <!-- Drip body - starts wide in brush stroke, narrows, ends in blob -->
            <path d="M <%= x_pos - merge_w/2 + x_wobble %>,<%= y_merge %>
                     Q <%= x_pos - merge_w/2 - 5 + x_wobble %>,<%= y_exit %> <%= x_pos - neck_w/2 + x_wobble %>,<%= y_neck %>
                     Q <%= x_pos - mid_w/2 - 4 + x_wobble %>,<%= y_mid - 30 %> <%= x_pos - mid_w/2 + x_wobble %>,<%= y_mid %>
                     Q <%= x_pos - mid_w/2 + 3 + x_wobble %>,<%= y_bulge - 15 %> <%= x_pos - blob_w/2 + x_wobble %>,<%= y_bulge %>
                     Q <%= x_pos - blob_w/2 - 5 + x_wobble %>,<%= y_blob_top %> <%= x_pos - blob_w/2 + 4 + x_wobble %>,<%= y_blob_top + 12 %>
                     Q <%= x_pos - blob_w/3 + x_wobble %>,<%= y_end + 10 %> <%= x_pos + x_wobble %>,<%= y_end + 14 %>
                     Q <%= x_pos + blob_w/3 + x_wobble %>,<%= y_end + 10 %> <%= x_pos + blob_w/2 - 4 + x_wobble %>,<%= y_blob_top + 12 %>
                     Q <%= x_pos + blob_w/2 + 5 + x_wobble %>,<%= y_blob_top %> <%= x_pos + blob_w/2 + x_wobble %>,<%= y_bulge %>
                     Q <%= x_pos + mid_w/2 - 3 + x_wobble %>,<%= y_bulge - 15 %> <%= x_pos + mid_w/2 + x_wobble %>,<%= y_mid %>
                     Q <%= x_pos + mid_w/2 + 4 + x_wobble %>,<%= y_mid - 30 %> <%= x_pos + neck_w/2 + x_wobble %>,<%= y_neck %>
                     Q <%= x_pos + merge_w/2 + 5 + x_wobble %>,<%= y_exit %> <%= x_pos + merge_w/2 + x_wobble %>,<%= y_merge %>
                     Z"
                  fill="url(#paint-gradient)"/>
          </g>
        <% end %>
      </g>

      <!-- Category names and bubbles (outside filter for crisp text) -->
      <% categories.each_with_index do |category, index| %>
        <%
          x_pos = ((index + 1) * (1000.0 / (categories.count + 1))).to_i
          depth_percentage = max_depth > 0 ? (category.drip_depth / max_depth * 100) : 0
          min_drip = 140
          max_drip = 400
          drip_length = min_drip + (depth_percentage / 100.0 * (max_drip - min_drip))
          y_exit = 72
          moments = category.learning_moments.chronological.to_a
          moment_count = moments.count
          x_wobble = (index % 3 - 1) * 3
        %>

        <!-- Category name in the brush stroke -->
        <text x="<%= x_pos %>" y="48"
              text-anchor="middle"
              style="font-size: 14px; font-weight: 600; fill: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
          <%= category.name %>
        </text>

        <!-- Learning moment bubbles - chronologically positioned -->
        <% if moment_count > 0 %>
          <% usable_length = drip_length - 80 %>
          <% moments.each_with_index do |moment, m_idx| %>
            <%
              # Position bubbles chronologically along the drip
              progress = moment_count > 1 ? m_idx.to_f / (moment_count - 1) : 0.5
              bubble_y = y_exit + 50 + (progress * usable_length)
              bubble_r = 13
            %>
            <!-- Bubble - same color as paint, slightly lighter -->
            <circle cx="<%= x_pos + x_wobble %>" cy="<%= bubble_y %>" r="<%= bubble_r %>"
                    fill="url(#bubble-fill)"/>
            <!-- Icon inside bubble - dark for contrast -->
            <text x="<%= x_pos + x_wobble %>" y="<%= bubble_y + 1 %>"
                  text-anchor="middle"
                  dominant-baseline="central"
                  style="font-size: 14px;">
              <%= case moment.engagement_type
                  when 'consumed' then 'ðŸ“–'
                  when 'experimented' then 'ðŸ§ª'
                  when 'applied' then 'ðŸ”¨'
                  when 'shared' then 'ðŸ“£'
                  end %>
            </text>
          <% end %>
        <% end %>
      <% end %>
    </svg>

    <!-- Expanded moments panels (positioned below) -->
    <div class="drips-details flex justify-around px-8 mt-4">
      <% categories.each do |category| %>
        <div data-drip-id="<%= category.id %>" class="drip-detail-container flex-1 max-w-xs mx-2">
          <div data-paint-drip-target="moments" class="hidden bg-surface border border-muted/20 rounded-lg p-4 shadow-lg">
            <h3 class="font-semibold text-text mb-3"><%= category.name %></h3>
            <div class="space-y-2 max-h-80 overflow-y-auto">
              <% category.learning_moments.chronological.each do |moment| %>
                <%= render "learning/droplet", moment: moment %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
